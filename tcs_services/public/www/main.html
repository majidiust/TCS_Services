<!DOCTYPE html>

<!--[if IEMobile 7]>
<html class="no-js iem7 oldie"><![endif]-->
<!--[if (IE 7)&!(IEMobile)]>
<html class="no-js ie7 oldie" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]>
<html class="no-js ie8 oldie" lang="en"><![endif]-->
<!--[if (IE 9)&!(IEMobile)]>
<html class="no-js ie9" lang="en"><![endif]-->
<!--[if (gt IE 9)|(gt IEMobile 7)]><!-->
<html class="no-js" lang="en"><!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>سیستم کنترل تردد گروه صنعتی کاوه</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- http://davidbcalhoun.com/2010/viewport-metatag -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Additional styles -->
    <link rel="stylesheet" href="css/styles/form3860.css?v=1">
    <link rel="stylesheet" href="css/styles/modal3860.css?v=1">
    <link rel="stylesheet" href="css/styles/progress-slider3860.css?v=1">
    <link rel="stylesheet" href="css/styles/switches3860.css?v=1">
    <link rel="stylesheet" href="css/styles/table3860.css?v=1">
    <link rel="stylesheet" href="css/kss.css">

    <!-- For all browsers -->
    <link rel="stylesheet" href="css/reset3860.css?v=1">
    <link rel="stylesheet" href="css/style3860.css?v=1">
    <link rel="stylesheet" href="css/colors3860.css?v=1">
    <link rel="stylesheet" media="print" href="css/print3860.css?v=1">
    <!-- For progressively larger displays -->
    <link rel="stylesheet" media="only all and (min-width: 480px)" href="css/4803860.css?v=1">
    <link rel="stylesheet" media="only all and (min-width: 768px)" href="css/7683860.css?v=1">
    <link rel="stylesheet" media="only all and (min-width: 992px)" href="css/9923860.css?v=1">
    <link rel="stylesheet" media="only all and (min-width: 1200px)" href="css/12003860.css?v=1">
    <!-- For Retina displays -->
    <link rel="stylesheet"
          media="only all and (-webkit-min-device-pixel-ratio: 1.5), only screen and (-o-min-device-pixel-ratio: 3/2), only screen and (min-device-pixel-ratio: 1.5)"
          href="css/2x3860.css?v=1">

    <!-- DataTables -->
    <link rel="stylesheet" href="js/libs/DataTables/jquery.dataTables3860.css?v=1">

    <!-- Webfonts -->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300' rel='stylesheet' type='text/css'>

    <!-- Additional styles -->
    <link rel="stylesheet" href="css/styles/progress-slider3860.css?v=1">
    <link rel="stylesheet" href="css/styles/switches3860.css?v=1">
    <link rel="stylesheet" href="css/styles/files3860.css?v=1">

    <!-- JavaScript at bottom except for Modernizr -->
    <script src="js/libs/modernizr.custom.js"></script>

    <!-- For Modern Browsers -->
    <link rel="shortcut icon" href="img/favicons/favicon.png">
    <!-- For everything else -->
    <link rel="shortcut icon" href="img/favicons/favicon.ico">
    <!-- For retina screens -->
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="img/favicons/apple-touch-icon-retina.png">
    <!-- For iPad 1-->
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="img/favicons/apple-touch-icon-ipad.png">
    <!-- For iPhone 3G, iPod Touch and Android -->
    <link rel="apple-touch-icon-precomposed" href="img/favicons/apple-touch-icon.png">

    <!-- iOS web-app metas -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <!-- Startup image for web apps -->
    <link rel="apple-touch-startup-image" href="img/splash/ipad-landscape.png"
          media="screen and (min-device-width: 481px) and (max-device-width: 1024px) and (orientation:landscape)">
    <link rel="apple-touch-startup-image" href="img/splash/ipad-portrait.png"
          media="screen and (min-device-width: 481px) and (max-device-width: 1024px) and (orientation:portrait)">
    <link rel="apple-touch-startup-image" href="img/splash/iphone.png" media="screen and (max-device-width: 320px)">

    <!-- Microsoft clear type rendering -->
    <meta http-equiv="cleartype" content="on">
</head>

<body class="clearfix with-menu with-shortcuts">

<!-- Prompt IE 6 users to install Chrome Frame -->
<!--[if lt IE 7]><p class="message red-gradient simpler">Your browser is <em>ancient!</em> <a
        href="http://browsehappy.com/">Upgrade to a different browser</a> or <a
        href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.
</p><![endif]-->

<!-- Title bar -->
<header role="banner" id="title-bar">
    <h2>
        سیستم کنترل تردد گروه صنعتی کاوه
    </h2>
</header>

<!-- Button to open/hide menu -->
<a href="javascript:void(0);" id="open-menu"><span>منو</span></a>

<!-- Button to open/hide shortcuts -->
<a href="javascript:void(0);" id="open-shortcuts"><span class="icon-thumbs"></span></a>

<!-- Main content -->
<section role="main" id="main">

    <noscript class="message black-gradient simpler">مرورگر شما از این نسخه از جاوا اسکریپت پیروی نمیکند. ممکن است بعضی
        از قابلیت ها کار نکند.
    </noscript>

    <div class="with-padding">

<div id="tableHolder">
        <table class="table responsive-table"
               style="width:100%;font-family: tahoma, verdana, sans-serif; direction: rtl;" id="traffic_table">

            <thead>

            <th scope="col" width="20%" class="align-center">تاریخ</th>
            <th scope="col" width="20%" class="align-center">زمان</th>
            <th scope="col" width="20%" class="align-center">پلاک</th>
            <th scope="col" width="40%" class="align-center">ابزار</th>

            </thead>
        </table>
</div>
</div>
    <div class="with-padding">
        <div class="columns" id="details" style="display: none;">

            <div class="box-layout four-columns twelve-columns-tablet" style="height:400px;">

                <p style="text-align:center;margin-top:10px;">
                    اطلاعات آخرین تردد
                </p>

                <hr/>
<center>
                <table style="width:80%;direction:rtl;line-height:30px;margin-left: 10px;">
                    <tr>
                        <td>
                            تاریخ تردد
                        </td>
                        <td id="lastTrafficDate">
                        </td>

                    </tr>
                    <tr>
                        <td>
                            زمان تردد
                        </td>
                        <td id="lastTrafficTime">
                        </td>

                    </tr>
                    <tr>
                        <td>
                            پلاک تشخیص داده شده
                        </td>
                        <td id="detectedPlate">
                        </td>
                    </tr>
                    <tr>
                        <td colaspan="2">
                            <hr/>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label for="input-3" class="label">نام</label>
                        </td>
                        <td>
                            <input type="text" name="firstName" id="firstName" size="9" class="input full-width"
                                   value="">
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <label for="input-3" class="label">نام خانوادگی</label>
                        </td>
                        <td>
                            <input type="text" name="lastName" id="lastName" size="9" class="input full-width" value="">
                        </td>
                    </tr>


                    <tr>
                        <td>
                            <label for="input-3" class="label">کدملی</label>
                        </td>
                        <td>
                            <input type="text" name="nationalityCode" id="nationalityCode" size="9"
                                   class="input full-width" value="">
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <hr/>
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align:center;">
                            <button class="button red-gradient"
                                    style="font-family: Tahoma; font-size: 10px; width: 80%;" onclick="nextImage();">
                                تصویر بعدی
                            </button>
                        </td>
                        <td style="text-align:center;">
                            <button class="button blue-gradient"
                                    style="font-family: Tahoma; font-size: 10px; width: 80%;" onclick="getAllRecordsForPlate(0, 500);">
                                تمامی ترددها
                            </button>
                        </td>
                    </tr>
                    <tr>
                        <td colaspan="2">
                            <hr/>
                        </td>
                    </tr>
                    <tr>
                        <td  style="text-align:center;">
                            <button class="button black-gradient"
                                    style="font-family: Tahoma; font-size: 12px; width: 80%;" onclick="$('#tableHolder').show(); $('#details').hide();">
بازگشت
                            </button>
                        </td>
                        <td  style="text-align:center;">
                            <button class="button green-gradient"
                                    style="font-family: Tahoma; font-size: 12px; width: 80%;" onclick="saveDetails();">
                                ثبت
                            </button>
                        </td>
                    </tr>
                </table>
    </center>
            </div>

            <div class="box-layout eight-columns twelve-columns-tablet" style="height:400px">
                <img id="lastTrafficImage" width="100%" height="100%" style="margin-bottm:10px;"/>
            </div>

        </div>

    </div>
    <div class="with-padding">

        <div id="queryTableHolder" style="display: none;">
            <button class="button black-gradient"
                    style="font-family: Tahoma; font-size: 12px; width: 80%;" onclick="$('#tableHolder').show(); $('#details').hide();$('#queryTableHolder').hide();">
                بازگشت
            </button>
            <hr/>
            <table class="table responsive-table"
                   style="width:100%;font-family: tahoma, verdana, sans-serif; direction: rtl;" id="query_traffic_table">

                <thead>

                <th scope="col" width="20%" class="align-center">تاریخ</th>
                <th scope="col" width="20%" class="align-center">زمان</th>
                <th scope="col" width="20%" class="align-center">پلاک</th>
                <th scope="col" width="40%" class="align-center">ابزار</th>

                </thead>
            </table>
        </div>
        </div>
</section>
<!-- End main content -->

<!-- Side tabs shortcuts -->
<ul id="shortcuts" role="complementary" class="children-tooltip tooltip-right">
    <li><a href="overview.html" class="shortcut-agenda" title="گزارش گیری">گزارش گیری</a></li>
    <li class="current"><a href="main.html" class="shortcut-messages" title="رخدادها">رخدادها</a></li>
    <li><a href="settings.html" class="shortcut-settings" title="تنظیمات">تنظیمات</a></li>
    <li><a href="dateReport.html" class="shortcut-contacts" title="براساس تاریخ">براساس تاریخ</a></li>
</ul>

<!-- Sidebar/drop-down menu -->
<section id="menu" role="complementary">

    <!-- This wrapper is used by several responsive layouts -->
    <div id="menu-content">

        <header>
            مدیر سیستم
        </header>

        <div id="profile">
            <img src="img/user.png" width="64" height="64" alt="User name" class="user-icon">

        </div>

        <!-- By default, this section is made for 4 icons, see the doc to learn how to change this, in "basic markup explained" -->
        <ul id="access" class="children-tooltip">
            <li><a href="inbox.html" title="رخدادهای سیستم"><span class="icon-inbox"></span><span class="count">2</span></a>
            </li>

            <li><a href="login.html" title="خروج"><span class="icon-user"></span></a></li>
            <li><span class="icon-gear"></span></li>
        </ul>

        <!--<section class="navigable" >-->
        <!--<ul class="big-menu">-->
        <!--<li class="with-right-arrow">-->
        <!--<span><span class="list-count">3</span>گزارش گیری</span>-->
        <!--<ul class="big-menu">-->
        <!--<li><a href="typography.html">امتیاز من</a></li>-->
        <!--<li><a href="columns.html">سابقه پرداخت</a></li>-->
        <!--<li><a href="tables.html">پرداخت جدید</a></li>-->
        <!--</ul>-->
        <!--</li>-->
        <!--<li class="with-right-arrow">-->
        <!--<span><span class="list-count">2</span>حساب کاربری</span>-->
        <!--<ul class="big-menu">-->
        <!--<li><a href="colors.html">پروفایل</a></li>-->
        <!--<li><a href="colors.html">کلمه عبور</a></li>-->
        <!--</ul>-->
        <!--</li>-->
        <!---->
        <!---->
        <!--</ul>-->
        <!--</section>-->
    </div>
    <!-- End content wrapper -->

    <!-- This is optional -->
    <!--<footer id="menu-footer">-->
    <!--<p class="button-height">-->
    <!--<input type="checkbox" name="auto-refresh" id="auto-refresh" checked="checked" class="switch float-right">-->
    <!--<label for="auto-refresh">Auto-refresh</label>-->
    <!--</p>-->
    <!--</footer>-->

</section>
<!-- End sidebar/drop-down menu -->

<!-- JavaScript at the bottom for fast page loading -->

<!-- Scripts -->
<script src="js/libs/jquery-1.8.2.min.js"></script>
<script src="js/setup.js"></script>

<!-- Template functions -->
<script src="js/developr.input.js"></script>
<script src="js/developr.navigable.js"></script>
<script src="js/developr.message.js"></script>
<script src="js/developr.modal.js"></script>
<script src="js/developr.notify.js"></script>
<script src="js/developr.scroll.js"></script>
<script src="js/developr.progress-slider.js"></script>
<script src="js/developr.tooltip.js"></script>
<script src="js/developr.content-panel.js"></script>

<!-- Plugins -->
<script src="js/libs/jquery.tablesorter.min.js"></script>
<script src="js/libs/DataTables/jquery.dataTables.min.js"></script>

<script>

var images;
var index = 0;
var count;
var plate;
$.template.init();
$(document).ready(function () {
    tablefy('traffic_table');
    tablefy('query_traffic_table');
    loadData(50);
});
function tablefy(tableid){
    var table = $('#' + tableid );
    table.dataTable({
        "aaSorting": [],
        "bDestroy": true,
        "bJQueryUI": true,
        "bProcessing": true,
        "bDeferRender": true,
        "oLanguage": {
            "sProcessing": "درحال پردازش...",
            "sLengthMenu": "نمایش محتویات _MENU_",
            "sZeroRecords": "موردی یافت نشد",
            "sInfo": "نمایش _START_ تا _END_ از مجموع _TOTAL_ مورد",
            "sInfoEmpty": "تهی",
            "sInfoFiltered": "(فیلتر شده از مجموع _MAX_ مورد)",
            "sInfoPostFix": "",
            "sSearch": "جستجو:",
            "sUrl": "",
            "oPaginate": {
                "sFirst": "ابتدا",
                "sPrevious": "قبلی",
                "sNext": "بعدی",
                "sLast": "انتها"
            }
        },
        'sPaginationType': 'full_numbers',
        'fnInitComplete': function (oSettings) {
        },
        "aoColumns": [
            {
                "sTitle": "تاریخ"
            },
            {
                "sTitle": "زمان"
            },
            {
                "sTitle": "پلاک"
            },
            {
                "sTitle": "",
                "fnRender": function (obj) {
                    var sReturn = obj.aData[obj.iDataColumn];
                    //sReturn = '<center><div onclick="openComplexModal(' + "'" + sReturn + "'" + ');" class="button compact icon-pictures">مشاهده تصاویر</div></center>';
                    sReturn = '<center><div onclick="showDetails(' + "'" + sReturn + "'" + ');" class="button compact icon-pictures" style="cursor:pointer;">مشاهده تصاویر</div></center>';
                    console.log(sReturn);
                    return sReturn;
                }
            }
        ]
    });

}
function showDetails(id) {
    //window.location.replace("'" + 'details.html?trafficId=' + id + "'");
    LoadById(id);
    console.log(id);
}
function loadData(pageSize) {
    $.ajax({
        type: 'GET',
        url: "/traffic/getPageCount/" + pageSize,
        dataType: 'json',
        success: function (result) {

            //alert(result.pageCount);
            count = parseInt(result.pageCount);
            reload(count, pageSize);
        },
        error: function () {
        },
        async: true
    });
}
function reload(page, pageSize) {
    $.ajax({
        type: 'GET',
        url: "/traffic/getTrafficPage/" + page + "/" + pageSize,
        dataType: 'json',
        success: function (result) {
            var exist = false;
            var results = [];
            var table = $('#traffic_table').dataTable();
            for (var i = result.length - 1; i >= 0; i--) {
                exist = true;
                var d = "";
                var correctedPlate = result[i].persianPlate2;
                if (correctedPlate && correctedPlate.length == 8) {
                    d = (correctedPlate[0] + correctedPlate[1] + correctedPlate[2] + correctedPlate[3] + correctedPlate[4] + correctedPlate[5] + " ایران " + correctedPlate[6] + correctedPlate[7]);
                    d = '<div style="direction:rtl">' + d + '</div>';
                }
                var newObject = [
                    result[i].date,
                    result[i].time,
                    d,
                    result[i]._id
                ];
                table.fnAddData(newObject);
                //results.push(newObject);
            }
            if (exist)
                if (page > count-30) {
                    setTimeout(function () {
                        reload(page - 1, pageSize);
                    }, 100);

                }

        },
        error: function () {
        },
        async: true});

}
function loadImage(recordId){
    recordI = recordId;
    $.ajax({
        type: 'GET',
        url: "/traffic/getListOfImages/" + recordId,
        dataType: 'json',
        success: function (result) {
            images = result;
            $("#lastTrafficImage").prop("src", recordId + '/' + result[0]);
            //var img = '<img src="' + recordId + '/' + result[0]  + '" width="100%"/>';
        },
        error: function () {
        },
        async: true});
}
function showImages(id) {
    alert(id);
}
function openComplexModal(recordId) {
    $.ajax({
        type: 'GET',
        url: "/traffic/getListOfImages/" + recordId,
        dataType: 'json',
        success: function (result) {

            $.modal({
                content: '<div  style="width:100%;"><img src="' + recordId + '/' + result[0] + '" width="100%"/> </div>',
                title: 'تصویر',
                width: 300,
                scrolling: true,
                actions: {
                    'بستن': {
                        color: 'red',
                        click: function (win) {
                            win.closeModal();
                        }
                    },
                    'مرکز': {
                        color: 'green',
                        click: function (win) {
                            win.centerModal(true);
                        }
                    },
                    'بزرگنمایی': {
                        color: 'red',
                        click: function () {
                            window.location = recordId + '/' + result[0];
                        }
                    }
                },
                contentBg: false,
                buttons: {
                    'بازگشت': {
                        classes: 'huge blue-gradient glossy full-width kaveh',
                        click: function (win) {
                            win.closeModal();
                        }
                    }
                },
                buttonsLowPadding: true
            });
        },
        error: function () {
        },
        async: true});
}
function getQueryStrings() {
    var assoc = {};
    var decode = function (s) {
        return decodeURIComponent(s.replace(/\+/g, " "));
    };
    var queryString = location.search.substring(1);
    var keyValues = queryString.split('&');

    for (var i in keyValues) {
        var key = keyValues[i].split('=');
        if (key.length > 1) {
            assoc[decode(key[0])] = decode(key[1]);
        }
    }

    return assoc;
}
function walk(node, func) {
    func(node);
    node = node.firstChild;
    while (node) {
        walk(node, func);
        node = node.nextSibling;
    }
}
function replaceNumbers(node) {
    if (node.nodeType == 3) //Text nodes only
        node.nodeValue = node.nodeValue.replace(/[0-9]/g, getArabicNumber);
}
function getArabicNumber(n) {
    return String.fromCharCode(1632 + parseInt(n, 10));
}
function LoadById(id) {
    $.ajax({
        type: 'GET',
        url: "/traffic/getTrafficById/" + id,
        dataType: 'json',
        success: function (result) {
            $("#tableHolder").hide();
            $("#queryTableHolder").hide();
            $("#details").show();
            var results = [];
            var d = "";
            var correctedPlate = result.persianPlate2;
            plate = correctedPlate;
            getProfile();
            if (correctedPlate && correctedPlate.length == 8) {
                d = (correctedPlate[0] + correctedPlate[1] + correctedPlate[2] + correctedPlate[3] + correctedPlate[4] + correctedPlate[5] + " ایران " + correctedPlate[6] + correctedPlate[7]);
                d = '<div style="direction:rtl">' + d + '</div>';
            }
            $("#lastTrafficDate").html(result.date);
            $("#lastTrafficTime").html(result.time);
            $("#detectedPlate").html(d);
            loadImage(result._id);
            walk(document.body, replaceNumbers);
        },
        error: function () {
        },
        async: false});
}
function nextImage() {
    index++;
    if (index >= images.length)
        index = 0;

    $("#lastTrafficImage").prop("src", recordI + '/' + images[index]);

}
function saveDetails() {
    var firstName = $("#firstName").val();
    var lastName = $("#lastName").val();
    var nationalityCode = $("#nationalityCode").val();
    console.log(firstName + " : " + lastName + " : " + nationalityCode);
    $.ajax({
        type: 'GET',
        url: "/traffic/saveProfile/" + firstName + "/" + lastName + "/" + nationalityCode + "/" + plate,
        dataType: 'json',
        success: function (result) {
            //alert('saved');
        },
        error: function () {
        },
        async: true});

}
function getProfile() {
    $.ajax({
        type: 'GET',
        url: "/traffic/getProfile/" + plate,
        dataType: 'json',
        success: function (result) {
            $("#firstName").val(result.firstName);
            $("#lastName").val(result.lastName);
            $("#nationalityCode").val(result.nationalityCode);
        },
        error: function () {
        },
        async: true});
}
function getAllRecordsForPlate(page, pageSize){
    console.log("all fo : " + plate);
    if(plate != "") {
        $.ajax({
            type: 'GET',
            url: "/traffic/getTrafficPageByPlate/" + page + "/" + pageSize + "/" + plate,
            dataType: 'json',
            success: function (result) {
                $('#query_traffic_table').dataTable().fnClearTable();

                $("#details").hide();
                $("#tableHolder").hide();
                $('#queryTableHolder').show();
                var exist = false;
                var results = [];
                var table = $('#query_traffic_table').dataTable();
                for (var i = result.length - 1; i >= 0; i--) {
                    exist = true;
                    var d = "";
                    var correctedPlate = result[i].persianPlate2;
                    if (correctedPlate && correctedPlate.length == 8) {
                        d = (correctedPlate[0] + correctedPlate[1] + correctedPlate[2] + correctedPlate[3] + correctedPlate[4] + correctedPlate[5] + " ایران " + correctedPlate[6] + correctedPlate[7]);
                        d = '<div style="direction:rtl">' + d + '</div>';
                    }
                    var newObject = [
                        result[i].date,
                        result[i].time,
                        d,
                        result[i]._id
                    ];
                    table.fnAddData(newObject);
                    //results.push(newObject);
                }
            },
            error: function () {
            },
            async: true});
    }

}
</script>
</body>
</html>
